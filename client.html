<!doctype html>

<html lang="en">
<head>
    <title>Yo</title>
    <meta charset="utf-8" />

    <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />

    <script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
    <script src="http://code.jquery.com/ui/1.9.2/jquery-ui.min.js"></script>

    <script src="http://layout.jquery-dev.net/lib/js/jquery.layout-latest.min.js"></script>

    <script src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
    <script src="http://api.maps.nokia.com/2.2.3/jsl.js?with=all"></script>

    <script>
        var map = (function () {
            var map = {
                map: undefined,
                info_bubbles: undefined,

                initialize: function (div_id) {
                    // TODO: Set the authentication token, which is needed by the web-services to authenticate your application.
                    nokia.Settings.set("appId", "_peU-uCkp-j8ovkzFGNU");
                    nokia.Settings.set("authenticationToken", "gBoUkAMoxoqIWfxWA5DuMQ");

                    if (nokia.maps.map && nokia.maps.map.Display) {
                        this.map = new nokia.maps.map.Display($(div_id)[0], {
                            components: [
                                new nokia.maps.map.component.Behavior(),
                                new nokia.maps.map.component.DistanceMeasurement(),
                                new nokia.maps.map.component.TypeSelector(),
                                new nokia.maps.map.component.ZoomBar(),
                                this.info_bubbles = new nokia.maps.map.component.InfoBubbles()
                            ],
                            zoomLevel: 14
                        });

                        // Want all bubbles
                        this.info_bubbles.options.autoClose = false;
                    }
                },

                geo: function (latitude, longitude) {
                    return new nokia.maps.geo.Coordinate(latitude, longitude);
                },

                line: function (points, color, thickness, visible) {
                    var line = new nokia.maps.map.Polyline(
                        points,
                        {
                            visibility: visible,
                            pen: {
                                strokeColor: color,
                                lineWidth: thickness
                            }
                        }
                    );

                    this.map.objects.add(line);
                    return line;
                },

                line_from_to: function (from, to, color, thickness, visible) {
                    return this.line([from, to], color, thickness, visible);
                },

                circle: function (center, radius, fill_color, outline_color, visible) {
                    var circle = new nokia.maps.map.Circle(
                        center,
                        radius,
                        {
                            visibility: visible,
                            pen: {
                                strokeColor: outline_color,
                                lineWidth: 1
                            },
                            brush: {
                                color: fill_color
                            }
                        }
                    );

                    this.map.objects.add(circle);
                    return circle;
                },

                marker: function (center, text, color, visible) {
                    var marker = new nokia.maps.map.StandardMarker(
                        center,
                        {
                            visibility: visible,
                            shape: 'balloon',
                            text: text,
                            brush: {
                                color: color
                            }
                        }
                    );

                    this.map.objects.add(marker);
                    return marker;
                },

                bubble: function (coordinate, text) {
                    return this.info_bubbles.openBubble(text, coordinate, null, false);
                },

                remove: function (object) {
                    this.map.objects.remove(object);
                },
            };

            return map;
        })();

        var POLL_DELAY = 1000;
        var LINE_THICKNESS = 4;

        var variables = {};
        var current_color = 0;
        var colors = _.shuffle([
            "#000", "#004", "#008", "#00c",
            "#040", "#044", "#048", "#04c",
            "#080", "#084", "#088", "#08c",
            "#0c0", "#0c4", "#0c8", "#0cc",
            "#400", "#404", "#408", "#40c",
            "#440", "#444", "#448", "#44c",
            "#480", "#484", "#488", "#48c",
            "#4c0", "#4c4", "#4c8", "#4cc",
            "#800", "#804", "#808", "#80c",
            "#840", "#844", "#848", "#84c",
            "#880", "#884", "#888", "#88c",
            "#8c0", "#8c4", "#8c8", "#8cc",
            "#c00", "#c04", "#c08", "#c0c",
            "#c40", "#c44", "#c48", "#c4c",
            "#c80", "#c84", "#c88", "#c8c",
            "#cc0", "#cc4", "#cc8", "#ccc"
        ]);

        function get_label_coordinate(shape) {
            if (shape.coordinate) {
                return shape.coordinate;
            } else {
                return shape.path.get(0);
            }
        }

        function create_label(variable, text) {
            variable.label = map.bubble(get_label_coordinate(variable.shape), text);
        }

        function create_variable(variable_info) {
            var points = variable_info.p;
            var shape = points.length == 2
                ? map.marker(points, "", colors[current_color], true)
                : map.line(points, colors[current_color], LINE_THICKNESS, true);
            current_color =(current_color + 1) % colors.length;
            var variable = {shape: shape, label: null};

            create_label(variable, variable_info.n);

            shape.addListener("click", function (event) {
                if (!variable.label || variable.label.getState() === "closed") {
                    create_label(variable, variable_info.n);
                }
            });

            return variable;
        }

        function destroy_variable(variable) {
            map.remove(variable.shape);
            variable.label.close();
        }

        function update_variable(variable, variable_info) {
            var points = variable_info.p;
            if (points.length == 2) {
                variable.shape.set("coordinate", points);
            } else {
                variable.shape.set("path", points);
            }
            variable.label.set("coordinate", points.slice(0, 2));
        }

        function update_variables(received_data) {
            var variable_names = [];
            var new_variables = {};
            for (var i in received_data) {
                var v = variables[i];
                var d = received_data[i];
                if (v) {
                    update_variable(v, d);
                } else {
                    v = create_variable(d)
                }
                new_variables[i] = v;
                delete variables[i];

                variable_names.push(d.n);
            }

            for (var i in variables) {
                destroy_variable(variables[i]);
            }

            variables = new_variables;

            $("#variables").html(variable_names.join("<br>"));
        }

        function request_variables() {
            $.ajax({
                url: "/lv",
                success: function (data) {
                    console.log(data);
                    update_variables(JSON.parse(data));
                    if (is_polling_enabled()) {
                        setTimeout(request_variables, POLL_DELAY);
                    }
                },
                error: function (data) {
                    disable_polling();
                }
            });
        }

        function is_polling_enabled() {
            return $("#live").prop("checked");
        }

        function enable_polling() {
            $("#live")
                .prop("checked", true)
                .button("refresh");

            request_variables();
        }

        function disable_polling() {
            $("#live")
                .prop("checked", false)
                .button("refresh");
        }

        $(function () {
            $('body').layout({west__applyDefaultStyles: true});

            $("#reload")
                .button()
                .click(request_variables);

            $("#live")
                .button()
                .click(function () {
                    if ($(this).prop("checked")) {
                        enable_polling();
                    } else {
                        disable_polling();
                    }
                });

            map.initialize('#map');

            map.map.zoomTo(nokia.maps.geo.BoundingBox.coverAll([
                map.geo(52.5133, 13.4027),
                map.geo(52.52799999999999, 13.428)
            ]));

            enable_polling();
        });
    </script>
    <style type="text/css">
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="map" class="ui-layout-center"></div>
    <div class="ui-layout-west">
        <div id="controls">
            <button id="reload">Reload</button>
            <input id="live" type="checkbox" /><label for="live">Live</label>
        </div>
        <div id="variables">
        </div>
    </div>
</body>
</html>
